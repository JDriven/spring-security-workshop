= Adding Spring Security

Adding Spring Security to an existing application can be quite a daunting prospect.
Merely adding the required dependencies to your project sets off a chain of events which can break your application and tests.

Maybe you're suddenly shown a login prompt which expects a generated password logged on startup. +
Maybe your tests now get the dreaded `401 Unauthorized`, or subsequently a `403 Forbidden`. +
Maybe you get a `ClassCastException` when trying to use your `Authentication#getPrincipal()`. +
So this should be fun!

We will walk you through adding Spring Security to an existing application,
by explaining what happens when you first add the dependencies, what to do next, and how to fix your tests.

== Context: Leave application
Imagine a Human Resources department that has a small application to track and approve/deny leave requests.
Initially this application was only used from within the HR department, who received requests via phone or email.
You can see the application in this state in link:leaveapp-initial/[leaveapp-initial], along with the current set of application tests.

Now we want to open up this application to all employees, so they can view and file (only their own) leave requests themselves.
Anyone from the HR department can then either approve or deny a leave request, and view all requests.
Up to you to implement these requirements for this small application.

== 0. Verify initial application
Before we make any changes, it's good to get familiar with link:leaveapp-initial/[the leave application] that we will work on.
Look through the code to see there's a single
link:leaveapp-initial/src/main/java/com/jdriven/leaverequest/LeaveRequestController.java[controller],
backed by a link:leaveapp-initial/src/main/java/com/jdriven/leaverequest/LeaveRequestService.java[service],
which connects to a link:leaveapp-initial/src/main/java/com/jdriven/leaverequest/LeaveRequestRepository.java[repository],
to store link:leaveapp-initial/src/main/java/com/jdriven/leaverequest/LeaveRequest.java[LeaveRequest]s.

=== Running the tests
In terms of tests, there's a single link:leaveapp-initial/src/test/java/com/jdriven/leaverequest/LeaveRequestServiceTest.java[test for the service],
and three different ways to test the controller:

1. once link:leaveapp-initial/src/test/java/com/jdriven/leaverequest/LeaveRequestControllerWebMvcTest.java[through @WebMvcTest],
2. once more link:leaveapp-initial/src/test/java/com/jdriven/leaverequest/LeaveRequestControllerSpringBootWebEnvMockTest.java[through @SpringBootTest(webEnvironment = WebEnvironment.MOCK)],
3. and finally link:leaveapp-initial/src/test/java/com/jdriven/leaverequest/LeaveRequestControllerSpringBootWebEnvRandomPortTest.java[through @SpringBootTest(webEnvironment = WebEnvironment.RANDOM_PORT)].

That way, ideally, at least one of these methods will look familiar to what you know from your own projects.

All these tests should already pass on your machine as well, so go ahead and give that a try, either through your IDE,
or using the below command as run from the workshop repository root.

.Run the tests
[source,bash]
----
# ~/workspace/spring-security-workshop $
./mvnw verify --file adding-spring-security/leaveapp-initial/pom.xml
----

=== Running the application
You should also be able to start the application through `LeaveRequestApplication` without any further changes,
either through your IDE, or again, using the below command as run from the workshop repository root.

.Run the application
[source,bash]
----
# ~/workspace/spring-security-workshop $
./mvnw spring-boot:run --file adding-spring-security/leaveapp-initial/pom.xml
----

Once running you can immediately see an empty array of leave requests using this url: http://localhost:8080/view/all.

To populate your application with leave requests, run any of the below `curl` or `HTTPie` commands.

.HTTPie commands to create, view and approve/deny leave requests.
[%collapsible]
====
[source,bash]
----
# Create a leave request for a specific user and time window
http POST ':8080/request/alice?from=2022-08-21&to=2022-09-11'

# View leave requests for employee
http :8080/view/employee/alice

# Approve leave request
http POST :8080/approve/2a37e1b6-d7e3-45fd-8b50-59357425d62e

# Deny leave request
http POST :8080/deny/2a37e1b6-d7e3-45fd-8b50-59357425d62e

# View leave request
http :8080/view/request/2a37e1b6-d7e3-45fd-8b50-59357425d62e

# View all leave requests
http :8080/view/all
----
====

.Curl commands to create, view and approve/deny leave requests.
[%collapsible]
====
[source,bash]
----
# Create a leave request for a specific user and time window
curl -X POST 'http://localhost:8080/request/alice?from=2022-08-21&to=2022-09-11'

# View leave requests for employee
curl http://localhost:8080/view/employee/alice

# Approve leave request
curl -X POST http://localhost:8080/approve/2a37e1b6-d7e3-45fd-8b50-59357425d62e

# Deny leave request
curl -X POST http://localhost:8080/deny/2a37e1b6-d7e3-45fd-8b50-59357425d62e

# View leave request
curl http://localhost:8080/view/request/2a37e1b6-d7e3-45fd-8b50-59357425d62e

# View all leave requests
curl http://localhost:8080/view/all
----
====

All of the above should just work on your machine.
If it did, you're ready to start making changes.

== 1. Adding Spring Security dependency
The first step in adding security to our application is picking the right dependency to add to our project.
However, even figuring out which dependency to add can be difficult these days!

=== Which dependency to add?
Looking at https://start.spring.io/#!type=maven-project&language=java&platformVersion=2.7.0&packaging=jar&jvmVersion=11&groupId=com.example&artifactId=demo&name=demo&description=Demo%20project%20for%20Spring%20Boot&packageName=com.example.demo&dependencies=security,oauth2-client,oauth2-resource-server,okta,data-ldap,azure-active-directory[start.spring.io]
we can see there are already six different dependencies related to Spring Security and/or OAuth2.
In part this is down to a https://spring.io/blog/2019/11/14/spring-security-oauth-2-0-roadmap-update[restructuring of OAuth2 support],
with OAuth2 resource server and client support now https://github.com/spring-projects/spring-security/wiki/OAuth-2.0-Features-Matrix[moved into Spring Security 5.2+].
As of June 1st 2022 the https://spring.io/blog/2022/06/01/spring-security-oauth-reaches-end-of-life[Spring Security OAuth project has reached End-of-Life].

In short we now advise against using the Spring Cloud Starter dependencies, and push towards using Spring Security support for OAuth2.

If your service will act as an OAuth2 resource server, by accepting JSON Web Tokens passed in from a gateway, you can use `spring-boot-starter-oauth2-resource-server`.
We expect this to be the most common form within a micro-services landscape, where a central gateway assumes the OAuth2 client role.
It is also what we will use throughout this blog post, although much of the details below apply to other forms as well.

If your service will act as an OAuth2 client to acquire JSON Web Tokens, you'll most likely want to use `spring-boot-starter-oauth2-client`.

Both starters will provide you with any transitive dependencies you might need for the most common security aspects.

=== What happens when you add the dependency?
Add the below dependency to link:leaveapp-initial/pom.xml[leaveapp-initial/pom.xml].

.oauth2-resource-server dependency snippet
[source,xml]
----
<dependency>
	<groupId>org.springframework.boot</groupId>
	<artifactId>spring-boot-starter-oauth2-resource-server</artifactId>
</dependency>
----

When you rerun the tests, you will notice all web related tests now fail with either a HTTP `401 Unauthorized` or `403 Forbidden` response, depending on whether it's a `GET` or `POST` request.

When you run `LeaveRequestApplication` as before, and again open http://localhost:8080/view/all, you are now presented with a login dialog.

.Please sign in
image:docs/signin.png[alt='Please sign in']

When you open the same endpoint from the commandline you immediately get a `HTTP/1.1 401` response.

We turn to the application logs to find out what happened in our application.
As it turns out, there's a curious new logline from
https://github.com/spring-projects/spring-boot/blob/2.7.x/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/security/servlet/UserDetailsServiceAutoConfiguration.java#L89[`UserDetailsServiceAutoConfiguration`]:

.Using generated security password warning
[source,text]
----
WARN UserDetailsServiceAutoConfiguration : 

Using generated security password: 9c991bee-bf35-4970-92ed-e5458d561a73

This generated password is for development use only. Your security configuration must be updated before running your application in production.
----

This auto configuration triggers when no other security configuration has been provided.
It sets up our application with a default user and generated password, as a fallback of sorts.
After all, if you're adding Spring Security to your class path you will want some form of security.
At the very least the log line and dialog serve as a reminder to configure exactly what you want in your application.

== 2. Configure OAuth2 resource server
Since we wish to configure our application to function as an OAuth2 resource server,
we can provide the required configuration to make the generated security password go away.
https://docs.spring.io/spring-security/reference/5.7.1/servlet/oauth2/resource-server/jwt.html[As indicated in the documentation], configuration takes the form of:

.application.yml snippet to configure oauth2 resource server
[source,yaml]
----
spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: http://localhost:8090/auth/realms/spring-cloud-gateway-realm
----

Add the above snippet to link:leaveapp-initial/src/main/resources/application.yml[application.yml].

Once added, the application will call out to the configured `issuer-uri` during startup, to configure the `JwtDecoder` through the
https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfig[OpenID Provider Configuration Information endpoint].

During development we will either
link:adding-spring-security/keycloak/[use Keycloak] or 
link:adding-spring-security/wiremock/[WireMock] to serve the configured `issuer-uri` endpoint.
WireMock is the easiest one to get working quickly; Keycloak takes some more effort, but can be used for your own projects as well.



== 3. Fixing our tests

.spring-security-test dependency snippet
[source,xml]
----
<dependency>
	<groupId>org.springframework.security</groupId>
	<artifactId>spring-security-test</artifactId>
	<scope>test</scope>
</dependency>
----


////

== Mock Keycloak
To save you from having to setup an OpenID Connect provider just yet, we've recorded the requests and responses needed for this workshop.
https://github.com/timtebeek/spring-security-samples/tree/main/adding-spring-security/leaveapp-complete/src/test/resources[Follow these instructions to run WireMock].
These recordings come from Keycloak, with setup covered in the link:../spring-cloud-gateway-oidc-tokenrelay/README.adoc[Spring Cloud Gateway with OpenID Connect workshop].

== Getting things done
* Read link:https://github.com/timtebeek/spring-security-samples/blob/main/adding-spring-security/README.adoc#what-happens-when-you-add-the-dependency[What happens when you add the dependency?] and add the Spring Security dependencies to the project in the link:pom.xml[pom.xml].
* link:https://github.com/timtebeek/spring-security-samples/blob/main/adding-spring-security/README.adoc#fixing-our-tests-part-1[Fix the user authorization tests] in the `AuthorizeUser` tests in the link:leaveapp-initial/src/test/java/com/jdriven/leaverequest/[test package]

Now we have secured the application on a user level, but what about roles?

* Read about link:https://github.com/timtebeek/spring-security-samples/blob/main/adding-spring-security/README.adoc#roles-and-authorizations[authorization on role level] and apply the suggested changes in the application.
* link:https://github.com/timtebeek/spring-security-samples/blob/main/adding-spring-security/README.adoc#fixing-our-tests-part-2[Fix the role authorization tests] in the `AuthorizeRole` tests in the link:leaveapp-initial/src/test/java/com/jdriven/leaverequest/[test package]

If you get stuck at any point, https://github.com/timtebeek/spring-security-samples/tree/main/adding-spring-security/leaveapp-complete/[leaveapp-complete] shows the application in a final form, with `src/main` and `src/test` updated to the above specification.

Your implementation could of course differ from ours; It'll be interesting to compare your approach with ours!

== What's next?
Congratulations, you solved the first challenge! ðŸ¥³

You can now choose to:

* link:../audit-spring-data-entities/[automatically track who modifies an entry, and when]
* link:../limit-spring-data-queries/[limit your query results to the active user]
* link:../access-decision-voter/[restrict which users can access what objects]
* link:../permission-evaluator/[separate read and write permissions on objects]
* link:../spring-cloud-gateway-oidc-tokenrelay/[route requests through a gateway]

== References
- https://docs.spring.io/spring-security/reference/servlet/getting-started.html[Hello Spring Security]
- https://docs.spring.io/spring-security/reference/5.7.1/servlet/oauth2/resource-server/index.html[OAuth 2.0 Resource Server]
- https://docs.spring.io/spring-security/reference/5.7.1/servlet/authorization/index.html[Authorization Chapter]
- https://docs.spring.io/spring-security/reference/5.7.1/servlet/authorization/method-security.html[Method Security]
- https://docs.spring.io/spring-security/reference/5.7.1/servlet/test/index.html[Testing Chapter]
////
